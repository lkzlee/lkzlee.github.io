---
layout: post
title: 分布式系统相关概念
date: 2018-08-07 11:14
categories: java技术
tags: 技术积累
description: 有时候经常不更新不总结，感觉就没进步，最近好久没更新了，不是有点忙就是懒惰，说白了都是我的借口。人性的七宗罪（懒惰、饕餮、贪婪、淫欲、骄傲、妒忌、愤怒），人性由此可见，做好产品经理的要务也是尽量满足这七种人性。不扯闲篇了，进入正式话题，作为一个码农其实平时经常会接触到分布式系统相关的处理，RPC调用，分布式协调，一致性，幂等，熔断，容错，分布式锁，分布式ID生成方案等等。本章从基础的分布式理论介绍，一窥究竟，看山之全貌，分布式各种知识点和涉及的理论及实践应有尽有。

---
*****
* TOC
{:toc}
*****


# 分布式理论

分布式理论这个概念，说起来研究生的时候可能基础理论知识会讲到，应付考试就死记硬背，当时压根不理解分布式，更没有很好的感悟，其实到现在也没有完全理解它的概念，没有特别深刻的认识，非要说的话，分布式系统需要细分以下几个领域：

	分布式缓存
	分布式存储
	分布式文件系统
	分布式锁
	分布式事务
	分布式任务调度
	分布式计算
	分布式消息
	分布式数据采集
	
我们可能平常接触到最多的：分布式存储（我同学原来刚好在EMC2是做分布式存储方案的，有一点点了解）、分布书锁、分布式缓存，分布式事务。
	
分布式系统概念从《分布式缓存》这本书介绍涉及了进程、线程、并发、锁等等，这些难道不是操作系统概念的基础知识吗？分布式系统也不是无根之木，无源之水，它也要涉及立足于基础的理论。说白了基础只要扎实，对于分布式概念的理解和学习也没啥难的，所以各位一定要基础扎实，这就好比是浑厚的内功，才能高屋建瓴，指点江山，自身技术视野和技术深度才能不断提升和加强。

## CAP理论

### C 一致性

分布式系统，数据可能有许多备份，在同一时刻是否具有一致的数据。

### A 可用性
分布式系统，挂掉部分节点后，系统还可以正常提供服务，响应相关请求的读写能力。

### P 容错性（有的也叫容忍性）

分布式系统，系统不能在一定时限内达到一致，说明数据发生了分区，说错的容忍性或容错，就是当发生数据分区后对于数据不一致的容忍能力或承受能力。

### CAP理论三者的取舍：CA、AP、CP
CA最主要的是保证一致性和可用性，最典型的应用就是LDAP，关系型数据库。

AP最主要放弃了一致性，保证高可用和容错性，最典型的应用是非关系型数据库，比如众多NoSQL都属于此类。

CP放弃了可用性，必须要要求一致性，分布式锁，分布式事务，2PC，3PC协议都是此类的选择，该CP能够保证一致性和分区容忍性无限延长，可用性较差，性能比较低。 

**CAP理论提出引出了一致性、可用性、分区容忍性的取舍问题，Paxos，Raft、2PC、3PC协议分别给出了一致性的解决方案。 **
## BASE理论

BASE：Basically Available、Soft State、Evently consistent （基本可用、软状态、最终一致）。

这个我个人理解其实是CAP理论的硬凑版本，其主要依据CAP理论实践过程中总结的经验，是对CAP理论三个特性的一种折衷方案，既然就是无法做到强一致性，那就保证最终一致，可用性和分区容错性也就能尽量保证，比如常常我们系统间各个RPC业务调用，各个业务的补偿任务，最终保证任务的状态正确完成就可以了。

## 强一致性-事务四特性ACID

原子性、一致性、隔离性、持久性

数据的隔离级别：RU、RC、RR、Serilize串行话
数据库的锁：共享锁、排它锁，gap间隙锁
MVCC：多版本并发控制协议

数据库事务实现：MVCC+事务隔离级别+数据锁，共同保证了事务的4个特性。

## 2PC和3PC提交协议

这两个协议估计大家都不陌生、是分布式事务的典型代表。

### 2PC协议

分为两个阶段：准备阶段和提交阶段

准备阶段：发送给所有参与本次事务的数据源，确认事务参与者是否准备就绪，并发送相关事务操作语句

提交阶段：依次提交参与本次事务的数据源执行，每个数据源操作成功，继续下一个数据源提交。

缺点：2PC协议最大的不足在于本质就两点：阻塞、单点、一致性问题。这个特性是因为它是阻塞性的协议。

阻塞：事务提交按每个数据源串行执行的，所以必须等到上一个提交成功才能进行下一个，如果上一个参与执行事务的挂掉了，这个事务就会被阻塞，一直等待超时中断事务；

单点：其实在分布式事务中都会有两个角色：协调者和参与者，一旦协调者挂掉，协调者是单点，会使整个两阶段提交无法运作，更为严重的是如果是在提交阶段协调者挂掉的话，则使得未提交的参与者继续锁定事务资源，无法释放。

一致性问题：协调者只发送部分参与者提交，就回导致数据不一致。

还有如果在这个过程中产生错误，还需要进行事务回滚，依次将之前所做的操作回滚掉。

在使用2PC协议过程中把握以下原则：

>能不用，尽量不用

>要想保证强一致性，也要在性能上多考虑下，尽量设置提交超时时间、补偿等等方式。

### 3PC协议
三阶段协议是在两阶段协议上发展而来，讲阶段分为：准备就绪、预提交、提交事务

3PC协议主要解决了阻塞和单点的问题。

阻塞问题：将2阶段拆分为3阶段，通过预提交，此阶段不锁定资源，大幅降低阻塞概率。

单点问题：各个事务参与者也引入了超时机制。

3PC协议虽然解决了2PC的两个问题，但是和2PC协议一样，它们都存在一致性问题。

2PC一致性问题：协调者只给部分参与者发送提交请求，部分没有提交，则出现不一致。比如发生了局部网络问题，一部分参与者收到事务提交清，协调者本身奔溃未发送剩余参与的提交事务请求，就会导致数据不一致性，

3PC一致性问题：一旦参与者无法及时收到些调整的信息，会自动提交，而不会一致持有事务资源阻塞，但这种机制也会导致数据一致性问题；比如协调者本身出现问题，协调者与参与者网络也出现故障，这时候在预提交阶段发生网络分区，协调者与参与者无法正常通信，参与者依然会提交事务。

关于分布式事务处理的优化思想：只要预提交成功，就保证真实提交成功，在实际使用环境中一般通过补偿策略保证事务真实提交完成。
## Paxos、Raft、Zab原子广播一致性协议

这是一个伟大发明。它是一个解决分布式系统多个节点就某个值达成一致决议的协议。本质上是少数服从多数的手段。

### Paxos

### Raft

### Zab 

## LEASE、Quorum NWR、MVCC、Gossip机制

Lease机制主要针对网络拥塞或瞬间网络抖动情况下，出现双主的情况解决办法。

Quorum NWR和MVCC机制主要解决分布式存储领域的一致性问题。

Gossip是一种去中心话，容错而有最终一致的算法。
